<div class="recipe-detail-container" *ngIf="!loading && !error && recipe">
  <div class="recipe-header">
    <div class="header-actions">
      <p-button
        icon="pi pi-arrow-left"
        (click)="goBack()"
        text="true"
        label="Back to Recipes"
      >
      </p-button>
      
      <p-button
        *ngIf="wakeLockSupported"
        [icon]="wakeLockEnabled ? 'pi pi-sun' : 'pi pi-moon'"
        (click)="toggleWakeLock()"
        [outlined]="!wakeLockEnabled"
        [severity]="wakeLockEnabled ? 'success' : 'secondary'"
        [label]="wakeLockEnabled ? 'Screen Active' : 'Keep Screen On'"
        pTooltip="Prevent screen from turning off while cooking"
        tooltipPosition="bottom"
      >
      </p-button>
    </div>
    <h1>{{ recipe.name }}</h1>
    <p class="cuisine">{{ recipe.cuisineName }} Cuisine</p>
  </div>

  <div class="recipe-content">
    <div class="recipe-main">
      <div class="recipe-overview">
        <div class="overview-stats">
          <div class="stat">
            <i class="pi pi-clock"></i>
            <span>{{ recipe.time }} min</span>
          </div>
          <div class="stat">
            <i class="pi pi-users"></i>
            <span>{{ recipe.servings }} servings</span>
          </div>
          <div class="stat">
            <p-tag
              [value]="getDifficultyText(recipe.difficulty)"
              [severity]="getDifficultySeverity(recipe.difficulty)"
            >
            </p-tag>
          </div>
          <div class="stat">
            <i class="pi pi-flash"></i>
            <span
            >{{ recipe.kcalPerServing | number : "1.0-0" }} kcal/serving</span
            >
          </div>
        </div>

        <div class="tags" *ngIf="recipe.tags.length > 0">
          <p-tag
            *ngFor="let tag of recipe.tags"
            [value]="tag"
            severity="secondary"
            class="tag"
          >
          </p-tag>
        </div>
      </div>

      <p-divider></p-divider>

      <div class="recipe-instructions">
        <h3>Instructions</h3>
        <p>{{ recipe.instructions }}</p>
      </div>

      <p-divider></p-divider>

      <div class="ingredients" *ngIf="recipe.recipeIngredients.length > 0">
        <h3>Ingredients</h3>
        <div class="ingredient-list">
          <div
            class="ingredient-item"
            *ngFor="let recipeIngredient of recipe.recipeIngredients"
          >
            <div class="ingredient-info">

              <div class="flex align-items-center gap-2 mb-1">
                <h4 class="m-0">{{ recipeIngredient.ingredient.name }}</h4>

                <i
                  *ngIf="recipeIngredient.ingredient.nutritionInfo?.length > 0"
                  class="pi pi-info-circle text-primary cursor-pointer hover:text-primary-600"
                  style="font-size: 1rem; margin-top: 4px;"
                  pTooltip="Show nutrition facts"
                  tooltipPosition="top"
                  (click)="showNutritionInfo($event, recipeIngredient.ingredient.nutritionInfo, op)"
                ></i>
              </div>

              <p class="category">{{ recipeIngredient.ingredient.category }}</p>
              <p class="quantity">Quantity: {{ recipeIngredient.quantity }}</p>
              <p *ngIf="recipeIngredient.notes" class="notes">
                Notes: {{ recipeIngredient.notes }}
              </p>
            </div>

            <div class="ingredient-nutrition">
              <small>
                {{ recipeIngredient.ingredient.kcal | number : "1.1-1" }} kcal |
                P: {{ recipeIngredient.ingredient.protein | number : "1.1-1" }}g
                | F: {{ recipeIngredient.ingredient.fat | number : "1.1-1" }}g |
                C: {{ recipeIngredient.ingredient.carbs | number : "1.1-1" }}g
              </small>
            </div>
          </div>
        </div>
      </div>

      <p-popover #op [style]="{ 'max-width': '300px' }">
        <div class="p-3">
          <h5 class="m-0 mb-2 font-bold text-color">Nutrition Facts</h5>

          <ul class="m-0 p-0 list-none">
            <li *ngFor="let info of currentNutritionInfo" class="flex align-items-center mb-2 last:mb-0">
              <i style="margin-top: 4px;" class="pi pi-check-circle text-green-500 mr-2 text-sm"></i>
              <span style="margin-left: 8px;" class="text-sm text-color-secondary">{{ info }}</span>
            </li>
          </ul>

          <p *ngIf="currentNutritionInfo.length === 0" class="text-sm text-color-secondary m-0">
            No specific nutrition info available.
          </p>
        </div>
      </p-popover>

    </div>

    <div class="recipe-sidebar">
      <p-card header="Serving suggestion">
        <img
          [attr.src]="getRecipeSrc(recipe)"
          width="350"
          height="350"
          alt="Recipe serving suggestion"
        />
      </p-card>
      <p-card header="Nutrition per Serving">
        <div class="nutrition-grid">
          <div class="nutrition-item">
            <span class="label">Calories</span>
            <span class="value">{{
                recipe.kcalPerServing | number : "1.0-0"
              }}</span>
          </div>
          <div class="nutrition-item">
            <span class="label">Protein</span>
            <span class="value"
            >{{ recipe.proteinPerServing | number : "1.1-1" }}g</span
            >
          </div>
          <div class="nutrition-item">
            <span class="label">Fat</span>
            <span class="value"
            >{{ recipe.fatPerServing | number : "1.1-1" }}g</span
            >
          </div>
          <div class="nutrition-item">
            <span class="label">Carbs</span>
            <span class="value"
            >{{ recipe.carbsPerServing | number : "1.1-1" }}g</span
            >
          </div>
        </div>
      </p-card>

      <p-card header="Actions" class="actions-card">
        <div class="action-buttons">
          <p-button
            label="Save Recipe"
            icon="pi pi-heart"
            severity="secondary"
            outlined="true"
          >
          </p-button>
          <p-button
            label="Share Recipe"
            icon="pi pi-share-alt"
            severity="secondary"
            outlined="true"
          >
          </p-button>
        </div>
      </p-card>

      <p-card header="Meal Preparation" class="meal-prep-card">
        <div class="meal-prep-section">
          <div class="servings-input">
            <label for="servings">Number of Servings:</label>
            <p-inputNumber
              [(ngModel)]="selectedServings"
              [min]="1"
              [max]="20"
              [showButtons]="true"
              spinnerMode="horizontal"
              inputId="servings"
              placeholder="1"
            >
            </p-inputNumber>
          </div>

          <div class="meal-prep-summary" *ngIf="selectedServings > 0">
            <h4>This will provide:</h4>
            <div class="nutrition-preview">
              <div class="preview-item">
                <span class="label">Calories:</span>
                <span class="value">{{
                    recipe.kcalPerServing * selectedServings | number : "1.0-0"
                  }}</span>
              </div>
              <div class="preview-item">
                <span class="label">Protein:</span>
                <span class="value"
                >{{
                    recipe.proteinPerServing * selectedServings
                      | number : "1.1-1"
                  }}g</span
                >
              </div>
              <div class="preview-item">
                <span class="label">Fat:</span>
                <span class="value"
                >{{
                    recipe.fatPerServing * selectedServings | number : "1.1-1"
                  }}g</span
                >
              </div>
              <div class="preview-item">
                <span class="label">Carbs:</span>
                <span class="value"
                >{{
                    recipe.carbsPerServing * selectedServings
                      | number : "1.1-1"
                  }}g</span
                >
              </div>
            </div>
          </div>

          <p-button
            label="Meal Prepared!"
            icon="pi pi-check-circle"
            (click)="onMealPrepared()"
            [loading]="cookingInProgress"
            [disabled]="!selectedServings || selectedServings < 1"
            severity="success"
            class="meal-prepared-btn"
          >
          </p-button>
        </div>
      </p-card>
    </div>
  </div>
</div>

<div *ngIf="loading" class="loading-state">
  <p>Loading recipe details...</p>
</div>

<div *ngIf="error" class="error-state">
  <p-button
    icon="pi pi-arrow-left"
    (click)="goBack()"
    text="true"
    label="Back to Recipes"
  >
  </p-button>
  <p>{{ error }}</p>
</div>

<p-toast position="bottom-right"></p-toast>
